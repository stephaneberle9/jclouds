# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: CI

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

# Cancel in-progress workflows for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build once, test once, reuse everywhere
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: temurin
          cache: maven

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      # Build, test, and package (including doc and src profiles)
      # Use 'install' instead of 'verify' to populate local Maven repository
      - name: Build and verify
        run: |
          ./mvnw clean install checkstyle:checkstyle \
            -B \
            -q \
            -Dorg.slf4j.simpleLogger.defaultLogLevel=ERROR \
            -Pdoc,src

      # Upload Maven repository with all built artifacts
      # This includes .jar, .pom, javadoc-jar, sources-jar, and flattened POMs
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-repository
          path: |
            ~/.m2/repository/org/apache/jclouds/
          retention-days: 1
          if-no-files-found: error

      # Also upload target directories for potential debugging
      - name: Upload build output on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            **/target/surefire-reports/
            **/target/*.log
          retention-days: 7

  # Optional: Matrix testing across multiple Java versions/OS
  # Uncomment to enable comprehensive compatibility testing
  # compatibility-test:
  #   needs: build-and-test
  #   strategy:
  #     matrix:
  #       os: [ubuntu-latest, windows-latest, macos-latest]
  #       java: [11, 17, 21]
  #       exclude:
  #         # Skip Windows/macOS for older Java versions to save time
  #         - os: windows-latest
  #           java: 11
  #         - os: macos-latest
  #           java: 11
  #   runs-on: ${{ matrix.os }}
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up JDK ${{ matrix.java }}
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: ${{ matrix.java }}
  #         distribution: temurin
  #         cache: maven
  #
  #     - name: Run tests
  #       run: ./mvnw test -B

  # Publish snapshot to Nexus (only on main branch push)
  publish-snapshot:
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: temurin
          cache: maven
          server-id: itemis-nexus
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      # Download pre-built artifacts from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-repository
          path: ~/.m2/repository/org/apache/jclouds/

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      # Deploy without rebuilding - artifacts are already built
      # Skip javadoc/source generation since they're already in the repository
      - name: Deploy snapshot to Nexus
        env:
          MAVEN_USERNAME: ${{ secrets.ITEMIS_NEXUS_USER }}
          MAVEN_PASSWORD: ${{ secrets.ITEMIS_NEXUS_PASS }}
        run: |
          ./mvnw deploy \
            -DskipTests \
            -Dmaven.install.skip=true \
            -Dmaven.javadoc.skip=true \
            -Dmaven.source.skip=true \
            -B -q

  # Publish release to Nexus (only on version tag push)
  publish-release:
    needs: build-and-test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: temurin
          cache: maven
          server-id: itemis-nexus
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      # Download pre-built artifacts from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-repository
          path: ~/.m2/repository/org/apache/jclouds/

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      # With CI-friendly Maven, just pass -Drevision to set the release version
      # No need for versions:set anymore - the flatten plugin handles it!
      - name: Deploy release to Nexus
        env:
          MAVEN_USERNAME: ${{ secrets.ITEMIS_NEXUS_USER }}
          MAVEN_PASSWORD: ${{ secrets.ITEMIS_NEXUS_PASS }}
        run: |
          ./mvnw deploy \
            -Drevision=${{ steps.version.outputs.version }} \
            -DskipTests \
            -Dmaven.install.skip=true \
            -Dmaven.javadoc.skip=true \
            -Dmaven.source.skip=true \
            -B -q
