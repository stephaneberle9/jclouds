# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: CI

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

# Cancel in-progress workflows for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build once, test once, reuse everywhere
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: temurin
          cache: maven

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      # Build, test, and package (including doc and src profiles)
      # Use 'install' instead of 'verify' to populate local Maven repository
      - name: Build and verify
        run: |
          ./mvnw clean install checkstyle:checkstyle \
            -B \
            -q \
            -Dorg.slf4j.simpleLogger.defaultLogLevel=ERROR \
            -Pdoc,src

      # Upload Maven repository with all built artifacts
      # This includes .jar, .pom, javadoc-jar, sources-jar, and flattened POMs
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-repository
          path: |
            ~/.m2/repository/org/apache/jclouds/
          retention-days: 1
          if-no-files-found: error

      # Also upload target directories for potential debugging
      - name: Upload build output on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            **/target/surefire-reports/
            **/target/*.log
          retention-days: 7

  # Optional: Matrix testing across multiple Java versions/OS
  # Uncomment to enable comprehensive compatibility testing
  # compatibility-test:
  #   needs: build-and-test
  #   strategy:
  #     matrix:
  #       os: [ubuntu-latest, windows-latest, macos-latest]
  #       java: [11, 17, 21]
  #       exclude:
  #         # Skip Windows/macOS for older Java versions to save time
  #         - os: windows-latest
  #           java: 11
  #         - os: macos-latest
  #           java: 11
  #   runs-on: ${{ matrix.os }}
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up JDK ${{ matrix.java }}
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: ${{ matrix.java }}
  #         distribution: temurin
  #         cache: maven
  #
  #     - name: Run tests
  #       run: ./mvnw test -B

  # Publish snapshot to Nexus (only on main branch push)
  publish-snapshot:
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: temurin
          cache: maven
          server-id: itemis-nexus
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      # Download pre-built artifacts from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-repository
          path: ~/.m2/repository/org/apache/jclouds/

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      # Check if the version is a SNAPSHOT before deploying
      # Non-SNAPSHOT versions on main branch are expected during release preparation
      - name: Check if version is snapshot
        id: check-snapshot
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
            echo "✓ Version $VERSION is a SNAPSHOT - will deploy to snapshots repository"
          else
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
            echo "ℹ️ Version $VERSION is a release version (no -SNAPSHOT suffix)"
            echo "   This is expected for release preparation commits."
            echo "   To deploy this release, push a tag: git tag v$VERSION && git push origin v$VERSION"
          fi

      # Deploy without rebuilding - artifacts are already built
      # Skip javadoc/source generation since they're already in the repository
      - name: Deploy snapshot to Nexus
        if: steps.check-snapshot.outputs.is_snapshot == 'true'
        env:
          MAVEN_USERNAME: ${{ secrets.ITEMIS_NEXUS_USER }}
          MAVEN_PASSWORD: ${{ secrets.ITEMIS_NEXUS_PASS }}
        run: |
          ./mvnw deploy \
            -DskipTests \
            -Dmaven.install.skip=true \
            -Dmaven.javadoc.skip=true \
            -Dmaven.source.skip=true \
            -B -q

  # Publish release to Nexus (only on version tag push)
  publish-release:
    needs: build-and-test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: temurin
          cache: maven
          server-id: itemis-nexus
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      # Download pre-built artifacts from build job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-repository
          path: ~/.m2/repository/org/apache/jclouds/

      - name: Make Maven wrapper executable
        run: chmod +x mvnw

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      # Verify the version is not a SNAPSHOT before deploying as release
      - name: Check if version is release
        id: check-release
        run: |
          TAG_VERSION="${{ steps.version.outputs.version }}"
          POM_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)

          echo "Tag version: $TAG_VERSION"
          echo "POM version: $POM_VERSION"

          # Check if POM version contains SNAPSHOT
          if [[ "$POM_VERSION" == *-SNAPSHOT ]]; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "❌ ERROR: Cannot deploy as release - POM version $POM_VERSION is a SNAPSHOT"
            echo "Please update pom.xml to a release version before tagging"
            exit 1
          fi

          # Check if tag version matches POM version
          if [[ "$TAG_VERSION" != "$POM_VERSION" ]]; then
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "❌ ERROR: Tag version ($TAG_VERSION) does not match POM version ($POM_VERSION)"
            echo "Please ensure the tag matches the version in pom.xml"
            exit 1
          fi

          echo "is_release=true" >> $GITHUB_OUTPUT
          echo "✓ Version $TAG_VERSION is a release version - will deploy"

      # With CI-friendly Maven, just pass -Drevision to set the release version
      # No need for versions:set anymore - the flatten plugin handles it!
      - name: Deploy release to Nexus
        if: steps.check-release.outputs.is_release == 'true'
        env:
          MAVEN_USERNAME: ${{ secrets.ITEMIS_NEXUS_USER }}
          MAVEN_PASSWORD: ${{ secrets.ITEMIS_NEXUS_PASS }}
        run: |
          ./mvnw deploy \
            -Drevision=${{ steps.version.outputs.version }} \
            -DskipTests \
            -Dmaven.install.skip=true \
            -Dmaven.javadoc.skip=true \
            -Dmaven.source.skip=true \
            -B -q
